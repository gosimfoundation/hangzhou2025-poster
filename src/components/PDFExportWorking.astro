---
// Working PDF export with proper content capture
---

<div class="pdf-button-wrapper">
  <button id="pdf-export-working" class="pdf-export-button">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
    </svg>
    导出PDF
  </button>
</div>

<style>
  .pdf-button-wrapper {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 99999;
  }

  .pdf-export-button {
    background: #f4f593;
    color: #333;
    border: 2px solid #333;
    padding: 12px 24px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-family: 'Noto Sans SC', sans-serif;
  }

  .pdf-export-button:hover {
    background: #e8e980;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
  }

  .pdf-export-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @media print {
    .pdf-button-wrapper {
      display: none !important;
    }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('pdf-export-working');
    
    btn.addEventListener('click', function() {
      console.log('PDF export started');
      btn.disabled = true;
      btn.textContent = '生成中...';
      
      // Get the main content wrapper directly from the page
      const content = document.querySelector('.page-wrapper');
      
      if (!content) {
        console.error('Content not found');
        alert('无法找到页面内容');
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> 导出PDF';
        return;
      }
      
      // Hide the PDF button before generating
      const btnWrapper = document.querySelector('.pdf-button-wrapper');
      if (btnWrapper) {
        btnWrapper.style.visibility = 'hidden';
      }
      
      // Calculate dimensions
      const contentWidth = 480; // Fixed width for mobile layout
      const contentHeight = content.scrollHeight;
      
      console.log('Content dimensions:', contentWidth, 'x', contentHeight);
      
      // Configuration for full page capture
      const opt = {
        margin:       0,
        filename:     'GOSIM-Poster.pdf',
        image:        { 
          type: 'jpeg', 
          quality: 0.95 
        },
        html2canvas:  { 
          scale: 2,
          useCORS: true,
          logging: true,
          letterRendering: true,
          allowTaint: true,
          width: contentWidth,
          height: contentHeight,
          windowWidth: contentWidth,
          windowHeight: contentHeight,
          scrollX: 0,
          scrollY: -window.scrollY // Compensate for current scroll position
        },
        jsPDF:        { 
          unit: 'px', 
          format: [contentWidth, contentHeight], 
          orientation: 'portrait',
          compress: true
        },
        pagebreak:    { 
          mode: 'avoid-all' 
        },
        enableLinks: false
      };
      
      // Generate PDF directly from the page content
      console.log('Generating PDF with options:', opt);
      
      html2pdf()
        .set(opt)
        .from(content)
        .save()
        .then(function() {
          console.log('PDF generated successfully');
          // Show button again
          if (btnWrapper) {
            btnWrapper.style.visibility = 'visible';
          }
          btn.disabled = false;
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> 导出PDF';
        })
        .catch(function(error) {
          console.error('PDF export error:', error);
          // Show button again
          if (btnWrapper) {
            btnWrapper.style.visibility = 'visible';
          }
          btn.disabled = false;
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> 导出PDF';
          alert('PDF导出失败: ' + (error.message || 'Unknown error'));
        });
    });
  });
</script>